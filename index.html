<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitud de Alta de Servicio</title>

  <style>
    /* --- ESTILOS VISUALES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f3f6fb 0%, #dde7f7 40%, #f5f9ff 100%);
      min-height: 100vh; padding: 30px 15px;
    }
    .container {
      width: 100%; max-width: 960px; margin: 0 auto;
      background: #ffffff; border-radius: 10px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.15); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
      color: #fff; padding: 15px 28px; font-size: 22px; font-weight: 700;
      display: flex; align-items: center; gap: 15px;
    }
    .header img {
      height: 40px; background: white; padding: 5px; border-radius: 4px;
    }
    .content-wrapper { padding: 24px 28px 10px 28px; }
    .section-title {
      font-size: 14px; font-weight: 700; color: #4568dc;
      margin-bottom: 18px; padding-bottom: 8px;
      border-bottom: 2px solid #4568dc; text-transform: uppercase;
    }
    .row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px; margin-bottom: 14px;
    }
    .row.full { grid-template-columns: 1fr; }
    .col { display: flex; flex-direction: column; }
    label {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      margin-bottom: 4px; color: #2d3748;
    }
    input, select {
      width: 100%; padding: 7px 10px; font-size: 13px;
      border-radius: 4px; border: 1px solid #cbd5e0;
      background: #f8fafc; transition: all 0.2s ease;
    }
    input:focus, select:focus {
      outline: none; border-color: #4568dc; background: #ffffff;
      box-shadow: 0 0 0 2px rgba(69, 104, 220, 0.15);
    }
    input[readonly] { background: #edf2f7; color: #4a5568; cursor: not-allowed; }
    
    /* Teléfonos */
    .phone-group { display: flex; }
    .phone-prefix {
      padding: 7px 10px; background: #edf2f7; border: 1px solid #cbd5e0;
      border-right: none; border-radius: 4px 0 0 4px;
      font-weight: 600; color: #4a5568; font-size: 12px; display: flex; align-items: center;
    }
    .phone-input { border-radius: 0 4px 4px 0; }

    /* Bloques Dinámicos */
    .bloque-dir {
      border: 1px solid #e2e8f0; padding: 14px; margin-top: 12px;
      border-radius: 6px; background: #f8fafc; position: relative;
    }
    .bloque-dir strong { display: block; font-size: 13px; color: #4568dc; margin-bottom: 10px; }
    
    /* Footer */
    .footer {
      padding: 14px 22px; border-top: 1px solid #e2e8f0;
      display: flex; justify-content: flex-end; gap: 10px; background: #f7fafc;
    }
    button {
      padding: 8px 18px; font-size: 12px; font-weight: 600;
      border-radius: 4px; border: none; cursor: pointer; text-transform: uppercase;
    }
    .btn-nav { background: #e2e8f0; color: #2d3748; }
    .btn-primary { background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%); color: #fff; }
    .btn-primary:disabled { background: #cbd5e0; cursor: not-allowed; }

    /* Grillas Específicas */
    .row-sol-sam { grid-template-columns: 220px 220px; }
    .row-rut-cliente { grid-template-columns: 220px 1fr; }
    .row-nombre-fono { grid-template-columns: 1fr 220px; }
  </style>
</head>

<body>
  <div class="container">
        <div class="header" style="display: flex; align-items: center; gap: 15px;">
      <!-- LOGO TELEFÓNICA OFICIAL EN SVG BASE64 (No falla nunca) -->
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNNTAgMjBDMzMuNCAyMCAyMCAzMy40IDIwIDUwczEzLjQgMzAgMzAgMzBzMzAtMTMuNCAzMC0zMFM2Ni42IDIwIDUwIDIwem0wIDEwYzExIDAgMjAgOSAyMCAyMHMtOSAyMC0yMCAyMC0yMC05LTIwLTIwIDktMjAgMjAtMjB6IiBmaWxsPSIjMDAzMzg1Ii8+PHBhdGggZD0iTTUwIDM1YTE1IDE1IDAgMSAwIDAgMzAgMTUgMTUgMCAwIDAgMC0zMHptMCA1YTEwIDEwIDAgMSAxIDAgMjAgMTAgMTAgMCAwIDEgMC0yMHoiIGZpbGw9IiM1ZmJmNGMiLz48L3N2Zz4=" 
           alt="Logo" 
           style="height: 40px; width: 40px; border-radius: 50%;">
      <span>Solicitud de Alta de Servicio</span>
    </div>


    <form id="mainForm" onsubmit="return false;">
      <div class="content-wrapper">

        <!-- ================= PANTALLA 1 ================= -->
        <div class="section" id="pantalla1">
          <div class="section-title">Datos de la Solicitud</div>

          <div class="row row-sol-sam">
            <div class="col">
              <label>Solicitud Nro</label>
              <!-- Se carga vía Fetch al iniciar -->
              <input id="solicitud_nro" readonly placeholder="Obteniendo folio...">
            </div>
            <div class="col">
              <label>Fecha Ingreso</label>
              <input id="fecha_ingreso" readonly placeholder="Cargando...">
            </div>
          </div>

          <div class="row row-rut-cliente">
            <div class="col">
              <label>RUT Cliente (Ej: 76123456-K)</label>
              <input id="rut" required placeholder="12345678-9">
            </div>
            <div class="col">
              <label>Cliente</label>
              <input id="cliente" readonly placeholder="Se buscará automáticamente...">
            </div>
          </div>

          <div class="row row-sol-sam">
            <div class="col">
              <label>Nro SAM</label>
              <input id="sam" type="text" maxlength="6" inputmode="numeric" placeholder="123456" required>
            </div>
            <div class="col">
              <label>Razón Social</label>
              <select id="razon" required>
                <option value="" selected disabled>Seleccione…</option>
                <option>Telefonica Chile S.A.</option>
                <option>Telefonica Empresas S.A.</option>
              </select>
            </div>
          </div>

          <!-- Contactos -->
          <div class="row row-nombre-fono">
            <div class="col">
              <label>Ejecutivo Comercial</label>
              <input id="ejecutivo" type="text" required>
            </div>
            <div class="col">
              <label>Fono Ejecutivo</label>
              <div class="phone-group">
                <span class="phone-prefix">+56</span>
                <input id="fono_ejecutivo" class="phone-input" type="text" maxlength="9" placeholder="912345678">
              </div>
            </div>
          </div>

          <div class="row row-nombre-fono">
            <div class="col">
              <label>Contacto Cliente</label>
              <input id="contacto_cliente" type="text" required>
            </div>
            <div class="col">
              <label>Fono Cliente</label>
              <div class="phone-group">
                <span class="phone-prefix">+56</span>
                <input id="fono_cliente" class="phone-input" type="text" maxlength="9" placeholder="912345678">
              </div>
            </div>
          </div>

          <div class="row row-nombre-fono">
            <div class="col">
              <label>Contacto Técnico</label>
              <input id="contacto_tecnico" type="text" required>
            </div>
            <div class="col">
              <label>Fono Técnico</label>
              <div class="phone-group">
                <span class="phone-prefix">+56</span>
                <input id="fono_tecnico" class="phone-input" type="text" maxlength="9" placeholder="912345678">
              </div>
            </div>
          </div>

          <div class="row row-nombre-fono">
            <div class="col">
              <label>Jefe de Proyecto</label>
              <input id="jefe_proyecto" type="text" required>
            </div>
            <div class="col">
              <label>Fono Jefe Proy.</label>
              <div class="phone-group">
                <span class="phone-prefix">+56</span>
                <input id="fono_jefe" class="phone-input" type="text" maxlength="9" placeholder="912345678">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Proyecto</label>
              <input id="proyecto" type="text" required>
            </div>
            <div class="col">
              <label>PEP Gasto</label>
              <input id="pep" type="text" required>
            </div>
          </div>
        </div>

        <!-- ================= PANTALLA 2 ================= -->
        <div class="section" id="pantalla2" style="display:none">
          <div class="section-title">Datos del Servicio</div>

          <div class="row full">
            <div class="col">
              <label>Proveedor</label>
              <select id="proveedor" required>
                <option value="" selected disabled>Seleccione…</option>
                <option>ASCENTY</option><option>CIRIO</option><option>CLARO</option>
                <option>ENTEL</option><option>EXANET</option><option>GTD</option>
                <option>MUNDO PACIFICO</option><option>MURANO</option><option>REDCOL</option>
                <option>TELSUR</option><option>UFINET</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Actividad</label>
              <select id="actividad" required>
                <option value="" selected disabled>Seleccione…</option>
                <option>ALTA</option>
                <option>RECONFIGURACION</option>
                <option>UPGRADE</option>
                <option>TRASLADO</option>
              </select>
            </div>
            <div class="col">
              <label>Tipo Dirección</label>
              <select id="tipo_direccion" onchange="cambiarTipoDireccion()" required>
                <option value="" selected disabled>Seleccione…</option>
                <option value="UNICA">UNICA</option>
                <option value="MULTI">MULTIDIRECCIÓN</option>
              </select>
            </div>
          </div>

          <!-- UNICA -->
          <div id="bloque_unica" style="display:none">
            <div class="row full">
              <div class="col">
                <label>Dirección A (Busca en Google)</label>
                <input id="dir_unica" class="google-autocomplete" placeholder="Escribe para buscar...">
              </div>
            </div>
            <div class="row full">
              <div class="col">
                <label>Dirección B (Opcional)</label>
                <input id="dir_b_unica" class="google-autocomplete" placeholder="Escribe para buscar...">
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label>Servicio</label>
                <select id="servicio_unica">
                  <option value="" selected disabled>Seleccione…</option>
                  <option>Capa 2 Mpls</option>
                  <option>Capa 3 sin Calidad (BE)</option>
                  <option>Cruzada Fibra Optica</option>
                  <option>DWDM</option>
                  <option>FTTH</option>
                  <option>Infraestructura</option>
                  <option>Intenert Dedicado Tasa Agregación 1_1</option>
                  <option>VPN IP</option>
                </select>
              </div>
              <div class="col">
                <label>Capacidad</label>
                <select id="capacidad_unica">
                  <option value="" selected disabled>Seleccione…</option>
                  <option>1 Pelo</option>
                  <option>256 Kbps</option>
                  <option>1 Mbps</option>
                  <option>2 Mbps</option>
                  <option>10 Mbps</option>
                  <option>20 Mbps</option>
                  <option>20 MB/ 10 MB</option>
                  <option>50 Mbps</option>
                  <option>60 Mbps</option>
                  <option>100 Mbps</option>
                  <option>200 Mbps</option>
                  <option>300 Mbps</option>
                  <option>400 Mbps</option>
                  <option>600 Mbps</option>
                  <option>800 Mbps</option>
                  <option>1 Giga</option>
                  <option>1G / 500M</option>
                </select>
              </div>
            </div>
          </div>

          <!-- MULTI -->
          <div id="bloque_multi" style="display:none">
            <button type="button" onclick="agregarDireccion()" class="btn-primary" style="margin: 10px 0;">
              + Agregar Dirección
            </button>
            <div id="contenedorDirecciones"></div>
          </div>

          <div class="section-title" style="margin-top: 24px;">Costos y Plazos</div>
          
          <div class="row full">
             <div class="col"><label>Concepto Otros Costos</label><input id="concepto_otros_costos"></div>
          </div>
          <div class="row">
            <div class="col"><label>Moneda Otros</label><select id="moneda_otros_costos"><option>UF</option><option>USD</option></select></div>
            <div class="col"><label>Monto Otros</label><input id="monto_otros_costos" type="number"></div>
          </div>
           <div class="row">
            <div class="col"><label>Moneda Instalación</label><select id="moneda_instalacion"><option>UF</option><option>USD</option></select></div>
            <div class="col"><label>Costo Instalación</label><input id="costo_instalacion" type="number"></div>
          </div>
          <div class="row">
            <div class="col"><label>Moneda Renta</label><select id="moneda_renta"><option>UF</option><option>USD</option></select></div>
            <div class="col"><label>Valor Renta</label><input id="valor_renta" type="number"></div>
          </div>
          <div class="row full">
            <div class="col">
              <label>Plazo Meses</label>
              <select id="plazo_meses" required>
                <option>12</option><option>24</option><option>36</option><option>48</option><option>60</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <button type="button" class="btn-nav" onclick="mostrar(1)" id="btn_anterior" style="display:none">Anterior</button>
        <button type="button" class="btn-nav" onclick="mostrar(2)" id="btn_siguiente">Siguiente</button>
        <button type="button" id="btn_guardar" class="btn-primary" disabled onclick="guardarSolicitud()">
          Guardar Solicitud
        </button>
      </div>
    </form>
  </div>

  <!-- LÓGICA JAVASCRIPT -->
  <script>
    // ---------------------------------------------------------
    // 1. CONFIGURACIÓN
    // ---------------------------------------------------------
    // URL DE TU SCRIPT DE GOOGLE
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFgFQrqp0nyFNXXD20Fip_GH9VgKxh8qVWwfHugG5jlg2SHznKX-3MLmd5nPatLCSZ5g/exec"; 

    // LISTAS MAESTRAS (Para uso en modo Multi)
    const OPCIONES_SERVICIO = [
      "Capa 2 Mpls", "Capa 3 sin Calidad (BE)", "Cruzada Fibra Optica", 
      "DWDM", "FTTH", "Infraestructura", "Intenert Dedicado Tasa Agregación 1_1", "VPN IP"
    ];
    const OPCIONES_CAPACIDAD = [
      "1 Pelo", "256 Kbps", "1 Mbps", "2 Mbps", "10 Mbps", "20 Mbps", "20 MB/ 10 MB",
      "50 Mbps", "60 Mbps", "100 Mbps", "200 Mbps", "300 Mbps", "400 Mbps", 
      "600 Mbps", "800 Mbps", "1 Giga", "1G / 500M"
    ];

    // 2. INICIALIZACIÓN
    let contadorDirecciones = 0;
    
    function initMapsCallback() {
      console.log("Google Maps API cargada correctamente.");
      setupAutocomplete(document.getElementById('dir_unica'));
      setupAutocomplete(document.getElementById('dir_b_unica'));
    }

    function setupAutocomplete(inputElement) {
      if (inputElement) {
        new google.maps.places.Autocomplete(inputElement, {
          types: ['geocode'],
          componentRestrictions: { country: "cl" }
        });
      }
    }

    // 3. NAVEGACIÓN
    function mostrar(n) {
      const p1 = document.getElementById("pantalla1");
      const p2 = document.getElementById("pantalla2");
      const btnGuardar = document.getElementById("btn_guardar");
      
      const btnSiguiente = document.getElementById("btn_siguiente");
      const btnAnterior = document.getElementById("btn_anterior");

      if (n === 2) {
        const sam = document.getElementById("sam").value;
        const rut = document.getElementById("rut").value;
        
        // Validaciones mínimas
        if (!rut) { alert("Ingrese el RUT del cliente."); return; }
        if (sam.length !== 6) { alert("El Nro SAM debe tener 6 dígitos."); return; }
        
        p1.style.display = "none";
        p2.style.display = "block";
        
        btnGuardar.disabled = false;
        // Lógica de botones: Ocultar Siguiente, Mostrar Anterior
        if(btnSiguiente) btnSiguiente.style.display = "none";
        if(btnAnterior) btnAnterior.style.display = "inline-block";

      } else {
        p1.style.display = "block";
        p2.style.display = "none";
        
        btnGuardar.disabled = true;
        // Lógica de botones: Mostrar Siguiente, Ocultar Anterior
        if(btnSiguiente) btnSiguiente.style.display = "inline-block";
        if(btnAnterior) btnAnterior.style.display = "none";
      }
    }

    // 4. DIRECCIONES
    function cambiarTipoDireccion() {
      const tipo = document.getElementById("tipo_direccion").value;
      const blqUnica = document.getElementById("bloque_unica");
      const blqMulti = document.getElementById("bloque_multi");

      blqUnica.style.display = (tipo === "UNICA") ? "block" : "none";
      blqMulti.style.display = (tipo === "MULTI") ? "block" : "none";

      if (tipo === "MULTI" && contadorDirecciones === 0) {
        agregarDireccion();
      }
    }

    function agregarDireccion() {
      if (contadorDirecciones >= 40) { alert("Máximo 40 direcciones"); return; }
      contadorDirecciones++;

      // Crear selects dinámicos con las opciones maestras
      const htmlServicios = OPCIONES_SERVICIO.map(s => `<option>${s}</option>`).join("");
      const htmlCapacidad = OPCIONES_CAPACIDAD.map(c => `<option>${c}</option>`).join("");

      const div = document.createElement("div");
      div.className = "bloque-dir";
      div.innerHTML = `
        <strong>Dirección ${contadorDirecciones}</strong>
        <div class="row full">
          <div class="col"><label>Dirección</label><input class="dir-input-multi" placeholder="Buscar dirección..."></div>
        </div>
        <div class="row">
          <div class="col">
            <label>Servicio</label>
            <select class="serv-multi">${htmlServicios}</select>
          </div>
          <div class="col">
            <label>Capacidad</label>
            <select class="cap-multi">${htmlCapacidad}</select>
          </div>
        </div>
      `;
      document.getElementById("contenedorDirecciones").appendChild(div);
      
      if (window.google && window.google.maps) {
        setupAutocomplete(div.querySelector(".dir-input-multi"));
      }
    }

    // 5. VALIDACIÓN DE RUT ESTRICTA (VIA GOOGLE SCRIPT)
    async function buscarRazonSocial() {
      const rutInput = document.getElementById("rut");
      const clienteInput = document.getElementById("cliente");

      // Limpieza del RUT
      let rutLimpio = rutInput.value.replace(/\./g, "").replace(/\s/g, "").trim().toUpperCase();

      if (rutLimpio.length < 8) return; 

      // Bloquear todo mientras consulta
      clienteInput.value = "Consultando...";
      clienteInput.readOnly = true;
      rutInput.disabled = true; 

      const urlConsulta = `${SCRIPT_URL}?rut=${rutLimpio}`;

      try {
        const response = await fetch(urlConsulta);
        const data = await response.json(); 
        
        if (data.razon_social) {
          clienteInput.value = data.razon_social;
        } else {
          alert("❌ RUT no encontrado en la base de datos oficial.\nVerifique el número ingresado.");
          clienteInput.value = "";
          rutInput.focus();
        }
      } catch (error) {
        console.error("Error buscando RUT:", error);
        alert("⚠️ Error de conexión con el servicio de validación.");
        clienteInput.value = "";
      } finally {
        rutInput.disabled = false;
        clienteInput.readOnly = true; 
      }
    }

    // 6. CARGA INICIAL
    document.addEventListener("DOMContentLoaded", function () {
      
      try {
        // A) Fecha Hoy
        const fechaHoy = new Date().toISOString().split('T')[0];
        document.getElementById("fecha_ingreso").value = fechaHoy;
        
        // B) CORRELATIVO DESDE GOOGLE SHEETS
        fetch(SCRIPT_URL) // GET sin params trae el ID
          .then(r => r.json())
          .then(data => {
            if(data.next_id) {
               document.getElementById("solicitud_nro").value = data.next_id;
            } else {
               document.getElementById("solicitud_nro").value = "10440"; // Fallback por si falla
            }
          })
          .catch(e => {
             console.error("Error obteniendo folio:", e);
             document.getElementById("solicitud_nro").value = "10440";
          });

        console.log("Carga inicial OK");

        // C) Listeners
        const rutInput = document.getElementById("rut");
        if (rutInput) rutInput.addEventListener("blur", buscarRazonSocial);
        
        document.body.addEventListener("input", (e) => {
          if (e.target.classList.contains("phone-input") || e.target.id === "sam") {
            e.target.value = e.target.value.replace(/\D/g, "").slice(0, 9);
          }
        });

      } catch (err) {
        console.error("Error crítico en inicialización:", err);
      }
    });

    // 7. GUARDAR
    function guardarSolicitud() {
      const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
      
      let direccionesList = [];
      const tipoDir = getVal("tipo_direccion");
      
      if (tipoDir === "MULTI") {
        document.querySelectorAll(".bloque-dir").forEach((bloque, index) => {
          direccionesList.push({
            id: index + 1,
            direccion: bloque.querySelector(".dir-input-multi").value,
            servicio: bloque.querySelector(".serv-multi").value,
            capacidad: bloque.querySelector(".cap-multi").value
          });
        });
      } else {
        direccionesList.push({
          id: 1,
          direccion: getVal("dir_unica"),
          servicio: getVal("servicio_unica"),
          capacidad: getVal("capacidad_unica")
        });
      }

      const payload = {
        meta: {
          solicitud: getVal("solicitud_nro"),
          fecha: getVal("fecha_ingreso"),
          proyecto: getVal("proyecto"),
          pep: getVal("pep")
        },
        cliente: {
          rut: getVal("rut"),
          cliente_nombre: getVal("cliente"),
          sam: getVal("sam"),
          razon: getVal("razon"),
          contactos: {
            ejecutivo: getVal("ejecutivo"),
            fono_ejecutivo: getVal("fono_ejecutivo"),
            contacto_cliente: getVal("contacto_cliente"),
            fono_cliente: getVal("fono_cliente"),
            tecnico: getVal("contacto_tecnico"),
            fono_tecnico: getVal("fono_tecnico"),
            jefe: getVal("jefe_proyecto"),
            fono_jefe: getVal("fono_jefe")
          }
        },
        servicio: {
          proveedor: getVal("proveedor"),
          actividad: getVal("actividad"),
          tipo: tipoDir,
          items: direccionesList,
          direccion_b: getVal("dir_b_unica")
        },
        financiero: {
          concepto_otros: getVal("concepto_otros_costos"),
          moneda_otros: getVal("moneda_otros_costos"),
          monto_otros: getVal("monto_otros_costos"),
          moneda_instalacion: getVal("moneda_instalacion"),
          costo_instalacion: getVal("costo_instalacion"),
          moneda_renta: getVal("moneda_renta"),
          renta: getVal("valor_renta"),
          plazo: getVal("plazo_meses")
        }
      };

      const btn = document.getElementById("btn_guardar");
      btn.disabled = true;
      btn.innerText = "Guardando...";

      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(() => {
        alert("✅ Solicitud guardada correctamente.");
        window.location.reload(); 
      })
      .catch(error => {
        console.error("Error:", error);
        alert("❌ Error al guardar.");
        btn.disabled = false;
        btn.innerText = "Guardar Solicitud";
      });
    }
  </script>

  <!-- CARGA API GOOGLE AL FINAL -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVJJmzcxnJsHGwnOnPkC77rybEcuplxdc&libraries=places&callback=initMapsCallback" async defer></script>
</body>
</html>


