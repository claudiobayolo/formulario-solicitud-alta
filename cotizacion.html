<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOLICITUD DE COTIZACIÓN</title>

  <style>
    /* --- ESTILOS VISUALES (Basados en Index_2.html) --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f3f6fb 0%, #dde7f7 40%, #f5f9ff 100%);
      min-height: 100vh;
      padding: 15px; 
      color: #333;
    }

    .container {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header img {
      height: 40px;
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      object-fit: contain;
    }

    .content-wrapper { padding: 20px; }

    .section-title {
      font-size: 13px;
      font-weight: 800;
      color: #4568dc;
      margin-bottom: 12px;
      padding-bottom: 5px;
      border-bottom: 2px solid #4568dc;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* --- GRILLAS FLEXIBLES (SOLUCIÓN DESBORDE) --- */
    .row {
      display: flex;
      flex-wrap: wrap; /* Permite que bajen si no caben */
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .col { flex: 1; min-width: 200px; display: flex; flex-direction: column; }
    .col-full { flex: 100%; width: 100%; }

    /* Proporciones Específicas */
    .col-3-4 { flex: 3; min-width: 280px; } /* Dirección */
    .col-1-4 { flex: 1; min-width: 140px; } /* Comuna */

    /* Fila Técnica (5 columnas) - CORREGIDO */
    .row-5 {
      display: flex;
      flex-wrap: wrap; /* Clave: permite saltar de línea */
      gap: 8px;
      margin-bottom: 10px;
      width: 100%; /* Asegura que no se salga del contenedor */
    }
    
    .row-5 .col {
      flex: 1; /* Crecen para llenar espacio */
      min-width: 140px; /* Ancho mínimo antes de bajar de línea */
    }

    label {
      font-size: 10px; /* Texto más pequeño para encabezados apretados */
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 4px;
      color: #2d3748;
      white-space: nowrap; /* Evita que el título se parta feo */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 8px; /* Padding lateral reducido */
      font-size: 12px; /* Letra un poco más chica en inputs */
      border-radius: 4px;
      border: 1px solid #cbd5e0;
      background: #f8fafc;
      transition: all 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4568dc;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(69,104,220,0.15);
    }
    input[readonly] {
      background: #edf2f7;
      color: #4a5568;
      cursor: default;
    }
    textarea { min-height: 60px; resize: vertical; }

    /* Bloque repetible de Dirección */
    .bloque-dir {
      border: 1px solid #e2e8f0;
      padding: 15px; /* Más padding interno */
      margin-top: 10px;
      border-radius: 6px;
      background: #fcfcfc;
      position: relative;
    }
    .bloque-dir strong {
      display: block;
      font-size: 12px;
      color: #4568dc;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .btn-remove {
      position: absolute; right: 10px; top: 10px;
      padding: 4px 8px; font-size: 10px; font-weight: 700;
      border-radius: 4px; border: 1px solid #e53e3e;
      background: #fff; color: #e53e3e; cursor: pointer;
      text-transform: uppercase;
    }
    .btn-remove:hover { background: #e53e3e; color: #fff; }

    /* Botones */
    .actions { margin: 15px 0; }
    
    .btn-add {
      padding: 8px 15px; font-size: 11px; font-weight: 700;
      border-radius: 4px; border: 1px solid #cbd5e0;
      background: #edf2f7; color: #2d3748; cursor: pointer;
      text-transform: uppercase;
    }
    .btn-add:hover { background: #e2e8f0; }

    .btn-primary {
      display: block; width: 100%;
      padding: 12px; font-size: 14px; font-weight: 700;
      border-radius: 4px; border: none; cursor: pointer;
      color: #fff; text-transform: uppercase;
      background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
      margin-top: 20px;
    }
    .btn-primary:disabled { background: #cbd5e0; cursor: not-allowed; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <img src="https://1000marcas.net/wp-content/uploads/2021/04/Telefonica-logo.png" alt="Telefónica">
      <div>SOLICITUD DE COTIZACIÓN</div>
    </div>

    <form id="cotizacionForm" class="content-wrapper">
      
      <!-- 1. IDENTIFICADOR -->
      <div class="section-title">1. IDENTIFICADOR DEL CLIENTE Y PROYECTO</div>

      <div class="row">
        <div class="col">
          <label>FECHA SOLICITUD</label>
          <input type="date" id="FECHA_SOLICITUD" readonly>
        </div>
        <div class="col">
          <label>NRO PROYECTO</label>
          <input type="text" id="NRO_PROYECTO" placeholder="REF. INTERNA">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>RUT CLIENTE</label>
          <input type="text" id="RUT_CLIENTE" placeholder="EJ: 76123456-K" onblur="buscarCliente()">
        </div>
        <div class="col">
          <label>RAZÓN SOCIAL</label>
          <input type="text" id="RAZON_SOCIAL" readonly placeholder="SE COMPLETA AL VALIDAR RUT">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>EJECUTIVO COMERCIAL</label>
          <input type="text" id="EJECUTIVO_COMERCIAL">
        </div>
        <div class="col">
          <label>PREVENTA</label>
          <select id="PREVENTA">
            <option value="" selected>ELEGIR...</option>
            <option>ANDRES ALBERTO TAPIA LAGOS</option><option>CARLOS AROS HERRERA</option><option>CLAUDIO GUERRA VELIZ</option><option>CLAUDIO VARAS CARRILLO</option><option>DANIEL DAVID CARTEZ CÓRDOVA</option><option>DAVID ROMERO</option><option>ELIAZIN GALLARDO ASENCIO</option><option>ENZO BENAVIDES</option><option>ERWIN ISIDRO CID GALAF</option><option>EVELYN CONTRERAS CONTRERAS</option><option>FELIPE NAVARRO</option><option>FRANCISCO JAVIER ESCOBAR</option><option>FRANCO MARTÍNEZ DONOSO</option><option>GERARDO ANTONIO MONTECINOS MELLADO</option><option>GUSTAVO ADOLFO GERDING VARGAS</option><option>HECTOR FERNANDO RUIZ MENDOZA</option><option>HÉCTOR VALLADARES NUÑEZ</option><option>HELTON JUAN SEPULVEDA ARAVENA</option><option>HENRY NICOLAS FARIÑE VELIZ</option><option>IGNACIO DIAZ</option><option>ITALO UNDURRAGA ROJAS</option><option>IVÁN SARMIENTO</option><option>JAIME BARRERA PRIETO</option><option>JORGE OSVALDO FIGUEROA SOTO</option><option>JORGE RIVANO CONCHA</option><option>JOSÉ LABRÍN ESCOBEDO</option><option>JOSE LUIS CASTILLO VASQUEZ</option><option>JOSE MIGUEL ARANCIBIA</option><option>JUAN CARLOS JIMENEZ</option><option>JUANA CRISTINA NARVAEZ ARACENA</option><option>KATHIUSKA DE LA SANTISIMA TRI PERAZA MARTINEZ</option><option>LORENA ESPINOZA MEDINA</option><option>LUIS ORTIZ</option><option>MANUEL MACHUCA CARRASCO</option><option>MANUEL TORO CASAS-CORDERO</option><option>MAURICIO GUERRERO</option><option>NICOLAS CERDA</option><option>PABLO ORTEGA</option><option>RAÚL MARTÍNEZ ARAVENA</option><option>REINALDO PERDOMO MARCANO</option><option>RICHARD LIZARDO MALERMO NUÑEZ</option><option>ROBERTO CARLOS AROS ANGULO</option><option>ROBERTO FERNANDO PEREZ MOREIRA</option><option>ROBERTO TRINCADO</option><option>RONALD CAÑIZALES</option><option>RUBEN DAVID NAVIO GOMEZ</option><option>RUTH CAROLINA SOTO AVILES</option><option>WILLIAM CÁRDENAS FUENTES</option><option>YERKO ALEXANDER FLORES OSSES</option>
          </select>
        </div>
      </div>

      <!-- 2. DIRECCIONES -->
      <div class="section-title">2. DIRECCIONES EXTREMO USUARIO</div>
      
      <div id="CONTENEDOR_DIRECCIONES"></div>

      <div class="actions">
        <button type="button" class="btn-add" onclick="agregarBloqueDireccion()">+ AGREGAR DIRECCIÓN</button>
      </div>

      <!-- 3. CONTACTOS -->
      <div class="section-title">3. CONTACTOS</div>

      <!-- Fila Contacto Técnica: 3/4 + 1/4 -->
      <div class="row">
        <div class="col col-3-4">
          <label>CONTACTO TECNICO</label>
          <input type="text" id="CONTACTO_TECNICO">
        </div>
        <div class="col col-1-4">
          <label>FONO CONTACTO TECNICO</label>
          <input type="text" id="FONO_CONTACTO_TECNICO" value="+56 ">
        </div>
      </div>

      <div class="row full">
        <div class="col col-full">
          <label>OBSERVACIONES</label>
          <textarea id="OBSERVACIONES"></textarea>
        </div>
      </div>

      <button type="button" class="btn-primary" id="btnGuardar" onclick="enviar()">GUARDAR COTIZACIÓN</button>

    </form>
  </div>

  <script>
    // --- CONFIGURACIÓN ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyF09RN5Z6tZpjgetksHOiNKEwP_zRvN0KDZczOX8gnXS_kGcmN-im66XGYnAm3oHIY_g/exec"; 
    let contadorDirecciones = 0;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("FECHA_SOLICITUD").valueAsDate = new Date();
      agregarBloqueDireccion();
    });

    // --- FUNCIÓN 1: BUSCAR CLIENTE ---
    async function buscarCliente() {
      const rutInput = document.getElementById("RUT_CLIENTE");
      const razonInput = document.getElementById("RAZON_SOCIAL");
      const rut = rutInput.value.trim().toUpperCase();

      if (rut.length < 8) return;

      razonInput.value = "BUSCANDO...";
      rutInput.disabled = true;

      try {
        const response = await fetch(`${SCRIPT_URL}?rut=${rut}`);
        const data = await response.json();
        
        if (data.razonsocial) {
          razonInput.value = data.razonsocial;
          razonInput.style.backgroundColor = "#e6fffa";
        } else {
          razonInput.value = "";
          razonInput.placeholder = "NO ENCONTRADO - INGRESE MANUAL";
          razonInput.readOnly = false;
          razonInput.focus();
        }
      } catch (e) {
        console.error(e);
        razonInput.value = "";
        razonInput.readOnly = false; 
      } finally {
        rutInput.disabled = false;
      }
    }

    // --- FUNCIÓN 2: MULTIDIRECCIÓN ---
    function agregarBloqueDireccion() {
      contadorDirecciones++;
      const id = `DIR_${Date.now()}`;
      const container = document.getElementById("CONTENEDOR_DIRECCIONES");
      const showDelete = container.children.length > 0;

      const div = document.createElement("div");
      div.className = "bloque-dir";
      div.id = id;

      div.innerHTML = `
        <strong>DIRECCIÓN #${contadorDirecciones}</strong>
        ${showDelete ? `<button type="button" class="btn-remove" onclick="eliminarBloque('${id}')">ELIMINAR</button>` : ""}

        <!-- Fila 1: Dirección (3/4) + Comuna (1/4) -->
        <div class="row">
          <div class="col col-3-4">
            <label>DIRECCION EXTREMO USUARIO</label>
            <input type="text" class="DIRECCION_EXTREMO_USUARIO google-autocomplete" placeholder="BUSCAR DIRECCIÓN...">
          </div>
          <div class="col col-1-4">
            <label>COMUNA</label>
            <input type="text" class="COMUNA" readonly>
          </div>
        </div>

        <!-- Fila 2: Coordenadas -->
        <div class="row">
          <div class="col">
            <label>LATITUD</label>
            <input type="text" class="LATITUD" readonly>
          </div>
          <div class="col">
            <label>LONGITUD</label>
            <input type="text" class="LONGITUD" readonly>
          </div>
          <div class="col">
            <label>COORDENADAS</label>
            <input type="text" class="COORDENADAS" readonly placeholder="LAT, LONG">
          </div>
        </div>

        <!-- Fila 3: Nodo -->
        <div class="row full">
          <div class="col col-full">
            <label>DIRECCION EXTREMO NODO</label>
            <input type="text" class="DIRECCION_EXTREMO_NODO google-autocomplete" placeholder="BUSCAR DIRECCIÓN NODO...">
          </div>
        </div>

        <!-- Fila 4: Parámetros Técnicos (FLEXIBLE) -->
        <div class="row-5">
          <div class="col">
            <label>PRODUCTO</label>
            <select class="PRODUCTO">
              <option value="" selected>ELEGIR...</option>
              <option>ID</option><option>CAPA2</option><option>CAPA3</option><option>EODWDM</option>
            </select>
          </div>
          <div class="col">
            <label>SUBCATEGORIA</label>
            <input type="text" class="SUBCATEGORIA" value="NO APLICA">
          </div>
          <div class="col">
            <label>VELOCIDAD (BW)</label>
            <select class="VELOCIDAD_BW">
              <option value="">ELEGIR...</option>
              <option>1 MB</option><option>2 MB</option><option>3 MB</option><option>4 MB</option><option>5 MB</option>
              <option>10 MB</option><option>15 MB</option><option>20 MB</option><option>25 MB</option><option>30 MB</option>
              <option>35 MB</option><option>40 MB</option><option>45 MB</option><option>50 MB</option>
              <option>100 MB</option><option>150 MB</option><option>200 MB</option><option>250 MB</option><option>300 MB</option>
              <option>350 MB</option><option>400 MB</option><option>450 MB</option><option>500 MB</option><option>550 MB</option>
              <option>600 MB</option><option>650 MB</option><option>700 MB</option><option>750 MB</option><option>800 MB</option>
              <option>850 MB</option><option>900 MB</option>
              <option>1 GB</option><option>2 GB</option><option>3 GB</option><option>4 GB</option><option>5 GB</option>
              <option>6 GB</option><option>7 GB</option><option>8 GB</option><option>9 GB</option><option>10 GB</option>
              <option>100 GB</option>
            </select>
          </div>
          <div class="col">
            <label>HABILITACION</label>
            <select class="HABILITACION">
              <option value="">ELEGIR...</option>
              <option>DIURNA</option><option>NOCTURNA</option>
            </select>
          </div>
          <div class="col">
            <label>PROTECCION</label>
            <select class="PROTECCION">
              <option value="">ELEGIR...</option>
              <option>1+0</option><option>1+1</option><option>0+1</option>
            </select>
          </div>
        </div>
      `;
      container.appendChild(div);

      if (typeof google !== 'undefined' && google.maps && google.maps.places) {
        activarAutocomplete(div.querySelector(".DIRECCION_EXTREMO_USUARIO"), div);
        activarAutocomplete(div.querySelector(".DIRECCION_EXTREMO_NODO"), null);
      }
    }

    function eliminarBloque(id) {
      document.getElementById(id)?.remove();
    }

    // --- FUNCIÓN 3: GOOGLE MAPS ---
    function activarAutocomplete(inputElement, parentDiv) {
      const autocomplete = new google.maps.places.Autocomplete(inputElement, {
        componentRestrictions: { country: "cl" },
        fields: ["address_components", "geometry", "formatted_address"]
      });

      if (parentDiv) {
        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (!place.geometry) return;

          // Fijar a 7 decimales
          const lat = place.geometry.location.lat().toFixed(7);
          const lng = place.geometry.location.lng().toFixed(7);
          
          parentDiv.querySelector(".LATITUD").value = lat;
          parentDiv.querySelector(".LONGITUD").value = lng;
          parentDiv.querySelector(".COORDENADAS").value = `${lat}, ${lng}`;

          let comuna = "";
          for (const component of place.address_components) {
            if (component.types.includes("administrative_area_level_3")) {
              comuna = component.long_name;
              break;
            }
          }
          parentDiv.querySelector(".COMUNA").value = comuna.toUpperCase();
        });
      }
    }

    function initMap() {
      console.log("Maps Ready");
      document.querySelectorAll(".google-autocomplete").forEach(input => {
        const parent = input.closest(".bloque-dir");
        const isUser = input.classList.contains("DIRECCION_EXTREMO_USUARIO");
        activarAutocomplete(input, isUser ? parent : null);
      });
    }

    // --- FUNCIÓN 4: GUARDAR ---
    function enviar() {
      const btn = document.getElementById("btnGuardar");
      
      const data = {
        FECHA: document.getElementById("FECHA_SOLICITUD").value,
        PROYECTO: document.getElementById("NRO_PROYECTO").value,
        RUT: document.getElementById("RUT_CLIENTE").value,
        RAZON: document.getElementById("RAZON_SOCIAL").value,
        EJECUTIVO: document.getElementById("EJECUTIVO_COMERCIAL").value,
        PREVENTA: document.getElementById("PREVENTA").value,
        CONTACTO: document.getElementById("CONTACTO_TECNICO").value,
        FONO: document.getElementById("FONO_CONTACTO_TECNICO").value,
        OBSERVACIONES: document.getElementById("OBSERVACIONES").value,
        SITIOS: []
      };

      document.querySelectorAll(".bloque-dir").forEach((b, i) => {
        data.SITIOS.push({
          N: i + 1,
          DIRECCION: b.querySelector(".DIRECCION_EXTREMO_USUARIO").value,
          COMUNA: b.querySelector(".COMUNA").value,
          COORDS: b.querySelector(".COORDENADAS").value,
          NODO: b.querySelector(".DIRECCION_EXTREMO_NODO").value,
          PRODUCTO: b.querySelector(".PRODUCTO").value,
          BW: b.querySelector(".VELOCIDAD_BW").value,
          HABILITACION: b.querySelector(".HABILITACION").value,
          PROTECCION: b.querySelector(".PROTECCION").value
        });
      });

      console.log("Enviando...", data);
      btn.disabled = true;
      btn.innerText = "ENVIANDO...";

      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(() => {
        alert("¡COTIZACIÓN ENVIADA CORRECTAMENTE!");
        window.location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("ERROR AL ENVIAR. Verifique consola.");
        btn.disabled = false;
        btn.innerText = "GUARDAR COTIZACIÓN";
      });
    }
  </script>

  <!-- API KEY REAL -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVJJmzcxnJsHGwnOnPkC77rybEcuplxdc&libraries=places&callback=initMap" async defer></script>

</body>
</html>
